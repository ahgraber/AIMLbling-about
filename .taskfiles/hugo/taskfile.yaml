---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CONTENT_DIR: "./content/"
  BLOG_DIR: "{{ .CONTENT_DIR }}/blog"
tasks:
  new:
    desc: Create a new draft post from template
    cmds:
      - hugo new content blog/{{ .file }}.md
      # NOTE: using gnu sed via nix; if using osx sed may have to use `sed -i ''`
      - |
        sed -i "/title: \"\"/c\title: '\{\{ title \"{{ .title }}\" \}\}'" {{ .BLOG_DIR }}/{{ .file }}.md
    vars:
      title: '{{ or ( .title | lower) (fail "Variable `title` is required") }}'
      file: '{{ .title | replace " " "-" }}'
    preconditions:
      - {msg: "Hugo not found", sh: "type hugo"}

  publish:
    desc: Publish a draft post (set 'draft' to false and update the date)
    cmds:
      # NOTE: using gnu sed via nix; if using osx sed may have to use `sed -i ''`
      - |
        sed -i '/draft: true/c\draft: false' {{ .BLOG_DIR }}/{{ .file }}.md
      - |
        sed -i '/date: .*/c\date: {{ now.Format "2006-01-02" }}' {{ .BLOG_DIR }}/{{ .file }}.md
    vars:
      file: '{{ or ( .file | trimSuffix ".md") (fail "Variable `file` is required") }}'

  build:
    desc: Render all static site content
    cmd: hugo
    # cmd: nix build '.?submodules=1'
    preconditions:
      - {msg: "Hugo not found", sh: "type hugo"}

  demo:
    desc: Serve the site (with drafts enabled)
    cmd: hugo serve -D
    preconditions:
      - {msg: "Hugo not found", sh: "type hugo"}
