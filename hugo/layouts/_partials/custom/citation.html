{{/* Partial: citation
  Renders APA-style and BibTeX citations for a blog article using native Hextra codeblocks.
  Usage: {{ partial "components/citation.html" .
}}
Note: Must be applied within <content> ... </content> for proper rendering. References: -
https://arduin.io/papermod-tweaks/ - https://discourse.gohugo.io/t/cite-the-blog-post/19190/14 */}}
{{/* Extract author information */}}
{{ $authors := default (slice (dict "first" "Alexander" "middle" "H" "last" "Graber")) .Params.authors }}

{{/* Build formatted author names for citation */}}
{{ $formattedAuthors := slice }}
{{ range $authors }}
  {{ $singleAuthorName := "" }}
  {{ with .last }}
    {{ $singleAuthorName = . }}
  {{ end }}
  {{ with .first }}
    {{ if gt (len .) 0 }}
      {{ $singleAuthorName = printf "%s, %s." $singleAuthorName (substr . 0 1 | upper) }}
    {{ end }}
  {{ end }}
  {{ with .middle }}
    {{ if gt (len .) 0 }}
      {{ $singleAuthorName = printf "%s %s." $singleAuthorName (substr . 0 1 | upper) }}
    {{ end }}
  {{ end }}

  {{/* Add default if singleAuthorName is empty */}}
  {{ if eq $singleAuthorName "" }}
    {{ $singleAuthorName = "Graber, A. H." }}
  {{ end }}

  {{ $formattedAuthors = $formattedAuthors | append $singleAuthorName }}
{{ end }}

{{/* Join authors with proper APA formatting */}}
{{ $authorName := "" }}
{{ $authorCount := len $formattedAuthors }}
{{ if eq $authorCount 1 }}
  {{ $authorName = index $formattedAuthors 0 }}
{{ else if eq $authorCount 2 }}
  {{ $authorName = printf "%s & %s" (index $formattedAuthors 0) (index $formattedAuthors 1) }}
{{ else if gt $authorCount 2 }}
  {{ $lastAuthor := index $formattedAuthors (sub $authorCount 1) }}
  {{ $otherAuthors := first (sub $authorCount 1) $formattedAuthors }}
  {{ $authorName = printf "%s, & %s" (delimit $otherAuthors ", ") $lastAuthor }}
{{ end }}

{{/* Page metadata */}}
{{ $year := .Page.PublishDate.Format "2006, Jan 2" }}
{{ $title := .Page.Title }}
{{ $permalink := .Page.Permalink }}


<h2>Cite this article</h2>

<p>If you would like to reference this article, please consider citing it as:</p>

{{/* Build plain citation string (no markdown emphasis inside code fences) */}}
{{- $citationPlain := printf "%s (%s). %s. AI/MLbling-About. %s" $authorName $year $title $permalink -}}

{{/* APA Citation Block - using exact Hextra structure */}}
<div class="hextra-code-block citation-wrap hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
  {{- partial "components/codeblock" (dict "filename" "" "lang" "text" "base_url" "" "content" $citationPlain "options" (dict "linenos" false)) -}}

  {{- if or (eq site.Params.highlight.copy.enable nil) (site.Params.highlight.copy.enable) -}}
    {{- partialCached "components/codeblock-copy-button" (dict "filename" "") "" -}}
  {{- end -}}
</div>

<p>Or with BibTeX:</p>

{{/* BibTeX citation */}}
{{/* Derive fields for BibTeX */}}
{{- $pubYear := .Page.PublishDate.Format "2006" -}}
{{- $pubMonth := .Page.PublishDate.Format "01" -}}
{{- $pubDay := .Page.PublishDate.Format "02" -}}
{{- $cleanTitle := replaceRE "[{}]" "" $title -}}
{{- /* Create a BibTeX key: lastnameYYYYslugfragment */ -}}
{{- $firstAuthor := index $authors 0 -}}
{{- $lastName := (or $firstAuthor.last "graber") | urlize -}}
{{- $slugPart := (strings.TrimSuffix "/" (path.Base .Page.RelPermalink)) -}}
{{- $slugPart = replaceRE "[^a-zA-Z0-9]+" "" $slugPart -}}
{{- $bibKey := printf "%s%s%s" $lastName $pubYear (cond (gt (len $slugPart) 0) (printf "_%s" $slugPart) "") -}}
{{- /* Authors in BibTeX: "Last, F." style joined with ' and ' */ -}}
{{- $bibAuthors := slice -}}
{{- range $authors -}}
  {{- $la := .last | default "Graber" -}}
  {{- $fi := cond (gt (len (.first | default "")) 0) (substr .first 0 1) "" -}}
  {{- $mi := cond (gt (len (.middle | default "")) 0) (substr .middle 0 1) "" -}}
  {{- $name := printf "%s, %s%s" $la $fi (cond (ne $mi "") (printf "%s" $mi) "") -}}
  {{- $bibAuthors = $bibAuthors | append $name -}}
{{- end -}}
{{- $bibAuthorStr := delimit $bibAuthors " and " -}}

{{- /* Build BibTeX entry */ -}}
{{- $bibtex := printf "@online{%s,\n  author = {%s},\n  title = {%s},\n  year = {%s},\n  date = {%s-%s-%s},\n  url = {%s},\n  urldate = {%s},\n  note = {Blog post}\n}" $bibKey $bibAuthorStr $cleanTitle $pubYear $pubYear $pubMonth $pubDay $permalink (now.Format "2006-01-02") -}}

{{/* BibTeX Block - using exact Hextra structure */}}
<div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
  {{- partial "components/codeblock" (dict "filename" "" "lang" "bibtex" "base_url" "" "content" $bibtex "options" (dict "linenos" false)) -}}

  {{- if or (eq site.Params.highlight.copy.enable nil) (site.Params.highlight.copy.enable) -}}
    {{- partialCached "components/codeblock-copy-button" (dict "filename" "") "" -}}
  {{- end -}}
</div>
