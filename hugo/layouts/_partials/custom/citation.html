{{/* References:
  - https://arduin.io/papermod-tweaks/
  - https://discourse.gohugo.io/t/cite-the-blog-post/19190/14
*/}}

{{/* layouts/_partials/citation.html
  Renders an APA-style citation for a blog article with a copy button.
  Usage: {{ partial "citation.html" .
}}
Note: Must be applied within <content> ... </content> for proper rendering. */}}
{{/* Extract author information */}}
{{ $authors := default (slice (dict "first" "Alexander" "middle" "H" "last" "Graber")) .Params.authors }}

{{/* Build formatted author names for citation */}}
{{ $formattedAuthors := slice }}
{{ range $authors }}
  {{ $singleAuthorName := "" }}
  {{ with .last }}
    {{ $singleAuthorName = . }}
  {{ end }}
  {{ with .first }}
    {{ if gt (len .) 0 }}
      {{ $singleAuthorName = printf "%s, %s." $singleAuthorName (substr . 0 1 | upper) }}
    {{ end }}
  {{ end }}
  {{ with .middle }}
    {{ if gt (len .) 0 }}
      {{ $singleAuthorName = printf "%s %s." $singleAuthorName (substr . 0 1 | upper) }}
    {{ end }}
  {{ end }}

  {{/* Add default if singleAuthorName is empty */}}
  {{ if eq $singleAuthorName "" }}
    {{ $singleAuthorName = "Graber, A. H." }}
  {{ end }}

  {{ $formattedAuthors = $formattedAuthors | append $singleAuthorName }}
{{ end }}

{{/* Join authors with proper APA formatting */}}
{{ $authorName := "" }}
{{ $authorCount := len $formattedAuthors }}
{{ if eq $authorCount 1 }}
  {{ $authorName = index $formattedAuthors 0 }}
{{ else if eq $authorCount 2 }}
  {{ $authorName = printf "%s & %s" (index $formattedAuthors 0) (index $formattedAuthors 1) }}
{{ else if gt $authorCount 2 }}
  {{ $lastAuthor := index $formattedAuthors (sub $authorCount 1) }}
  {{ $otherAuthors := first (sub $authorCount 1) $formattedAuthors }}
  {{ $authorName = printf "%s, & %s" (delimit $otherAuthors ", ") $lastAuthor }}
{{ end }}

{{/* Page metadata */}}
{{ $year := .Page.PublishDate.Format "2006, Jan 2" }}
{{ $title := .Page.Title }}
{{ $permalink := .Page.Permalink }}
{{ $citationId := printf "citation-%d" now.UnixNano }}


<h2>Cite this article</h2>

If you would like to reference this article, please consider citing it as:
{{/* Build Markdown citation string (APA-ish) */}}
{{- $citationMarkdown := printf "%s (%s). *%s*. AI/MLbling-About. [%s](%s)" $authorName $year $title $permalink $permalink -}}


<div
  class="hextra-code-block group/code hx:bg-gray-50 dark:hx:bg-neutral-800 hx:mb-4 hx:mt-4 hx:rounded-md hx:border hx:border-black/5 dark:hx:border-white/10 hx:p-4">
  <div class="hx:flex hx:items-start hx:gap-4">
    <div class="hx:grow hx:min-w-0 hx:max-w-[68ch] hx:break-words">
      {{/* Rendered Markdown version (italics, link, etc.) */}}
      <div id="{{ $citationId }}" class="apa-citation hx:text-base hx:font-mono hx:leading-relaxed">
        {{ $citationMarkdown | .Page.RenderString }}
      </div>
      {{/* Hidden raw markdown source for copy */}}
      <textarea id="{{ $citationId }}-raw" class="hx:hidden">{{ $citationMarkdown }}</textarea>
    </div>
    <div class="hx:shrink-0 hx:flex hx:flex-col hx:items-end hx:pt-1">
      <button
        type="button"
        class="hextra-code-copy-btn hx:cursor-pointer hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:px-2 hx:py-1 hx:text-xs dark:hx:bg-primary-300/10 dark:hx:border-white/10 dark:hx:text-gray-400 dark:hx:hover:text-gray-50"
        data-copy-target="{{ $citationId }}"
        aria-label="Copy citation"
        title="Copy citation">
        Copy
      </button>
    </div>
  </div>
</div>

<script>
  (function(){
    const root=document.currentScript.previousElementSibling; if(!root) return;
    const btn=root.querySelector('[data-copy-target="{{ $citationId }}"]');
    if(!btn) return;
    btn.addEventListener('click',()=>{
      const raw=document.getElementById('{{ $citationId }}-raw');
      const text=raw?raw.value:"";
      if(!text) return;
      navigator.clipboard.writeText(text).then(()=>{
        const original=btn.textContent; btn.textContent='Copied!';
        setTimeout(()=>{btn.textContent=original;},1800);
      });
    });
  })();
</script>
